# ==============================================================================
# 範本名稱: Clean Artifact (clean-artifact.yml)
# 說明: 
#   清理下載至 Agent 的 Artifact 暫存檔。
#   通常在部署流程的最後執行，確保硬碟空間釋放。
#   設定了 condition: always()，確保無論部署成功失敗皆執行。
# ==============================================================================

parameters:
  - name: artifactName
    type: string
  - name: sourcePipeline
    type: string
  
  # 執行條件
  - name: runCondition
    type: string
    default: 'always()'

steps:
  - powershell: |
      $artifactName = "${{ parameters.artifactName }}"
      $sourcePipeline = "${{ parameters.sourcePipeline }}"
      
      # 決定 Artifact 路徑
      $artifactPath = "$(Pipeline.Workspace)/$artifactName"
      if ($sourcePipeline -ne 'current') {
          $artifactPath = "$(Pipeline.Workspace)/$sourcePipeline/$artifactName"
      }
      
      Write-Host "Cleaning up artifact at: $artifactPath"
      
      if (Test-Path $artifactPath) {
          Remove-Item -Path $artifactPath -Recurse -Force -ErrorAction SilentlyContinue
          Write-Host "Artifact cleaned up successfully."
      } else {
          Write-Host "Artifact path not found, nothing to clean."
      }
    displayName: '清理 Artifact 暫存檔'
    condition: ${{ parameters.runCondition }}
