# ==============================================================================
# 範本名稱: Extract Artifact (extract-artifact.yml)
# 說明: 
#   檢查指定的 Artifact 是否為 ZIP 壓縮檔。
#   如果是，則解壓縮至 'extracted' 子目錄。
#   最後設定變數 'WebDeployPackagePath' 供後續部署步驟使用。
# ==============================================================================

parameters:
  - name: artifactName
    type: string
  - name: sourcePipeline
    type: string
    default: 'current'
  
  # 執行條件
  - name: runCondition
    type: string
    default: 'succeeded()'

steps:
  - powershell: |
      $artifactName = "${{ parameters.artifactName }}"
      $sourcePipeline = "${{ parameters.sourcePipeline }}"
      
      # 決定基礎路徑
      $basePath = "$(Pipeline.Workspace)/$artifactName"
      if ($sourcePipeline -ne 'current') {
          $basePath = "$(Pipeline.Workspace)/$sourcePipeline/$artifactName"
      }
      
      Write-Host "Checking artifact at: $basePath"
      $packagePath = $basePath

      # 檢查是否有 ZIP 檔
      if (Test-Path $basePath) {
          $zipFile = Get-ChildItem -Path $basePath -Filter "*.zip" | Select-Object -First 1
          
          if ($zipFile) {
              Write-Host "Found compressed artifact: $($zipFile.FullName)"
              $extractPath = "$basePath/extracted"
              
              Write-Host "Extracting to: $extractPath"
              # 清理舊的解壓目錄 (如果存在)
              if (Test-Path $extractPath) { Remove-Item $extractPath -Recurse -Force }
              
              Expand-Archive -Path $zipFile.FullName -DestinationPath $extractPath -Force
              $packagePath = $extractPath
          } else {
              Write-Host "No zip file found. Assuming loose files."
          }
      }
      
      Write-Host "Setting WebDeployPackagePath to: $packagePath"
      Write-Host "##vso[task.setvariable variable=WebDeployPackagePath]$packagePath"
    displayName: '檢查並解壓縮 Artifact'
    condition: ${{ parameters.runCondition }}
