# ==============================================================================
# Template Name: IIS Website Backup (backup-iis.yml)
# Description: 
#   Compress and backup the contents of the specified website physical path.
#   1. Compress to zip (Filename: yyyy-MM-dd-HH-mm-ss.zip)
#   2. Save to backupPath
#   3. Keep the latest N backups based on backupRetentionCount
# ==============================================================================

parameters:
  - name: websitePhysicalPath
    type: string
  - name: backupPath
    type: string
  - name: backupRetentionCount
    type: number
    default: 5
  
  # Execution Condition
  - name: runCondition
    type: string
    default: 'succeeded()'

steps:
  - powershell: |
      $srcRaw = "${{ parameters.websitePhysicalPath }}"
      $destDirRaw = "${{ parameters.backupPath }}"
      $limit = ${{ parameters.backupRetentionCount }}
      
      # Expand Environment Variables (e.g. %SystemDrive% -> C:)
      $src = [System.Environment]::ExpandEnvironmentVariables($srcRaw)
      $destDir = [System.Environment]::ExpandEnvironmentVariables($destDirRaw)
      
      Write-Host "Starting Backup Process..."
      Write-Host "Source (Raw): $srcRaw"
      Write-Host "Source (Expanded): $src"
      Write-Host "Destination (Raw): $destDirRaw"
      Write-Host "Destination (Expanded): $destDir"
      Write-Host "Retention Count: $limit"

      # 1. Check if source exists
      if (-not (Test-Path $src)) {
          Write-Warning "Source path '$src' does not exist. Skipping backup."
          exit 0
      }

      # 2. Check if source is empty
      if ((Get-ChildItem $src -Force).Count -eq 0) {
          Write-Host "Source directory is empty. Nothing to backup."
          exit 0
      }

      # 3. Create backup directory (if not exists)
      if (-not (Test-Path $destDir)) {
          Write-Host "Backup directory does not exist. Creating: $destDir"
          New-Item -ItemType Directory -Force -Path $destDir | Out-Null
      }

      # 4. Execute Compression
      $timestamp = Get-Date -Format "yyyy-MM-dd-HH-mm-ss"
      $zipName = "$timestamp.zip"
      $zipPath = Join-Path $destDir $zipName
      
      Write-Host "Archiving content to: $zipPath"
      
      try {
          Compress-Archive -Path "$src\*" -DestinationPath $zipPath -Force -ErrorAction Stop
          Write-Host "Backup created successfully."
          # Set variable for Rollback use
          Write-Host "##vso[task.setvariable variable=_GeneratedBackupPath]$zipPath"
      }
      catch {
          Write-Warning "Failed to create backup. Error: $_"
          exit 0
      }

      # 5. Apply Retention Policy
      Write-Host "Applying retention policy (Keep latest $limit)..."
      $backups = Get-ChildItem -Path $destDir -Filter "*.zip" | Sort-Object CreationTime -Descending
      
      if ($backups.Count -gt $limit) {
          $toDelete = $backups | Select-Object -Skip $limit
          foreach ($file in $toDelete) {
              Write-Host "Deleting old backup: $($file.Name)"
              Remove-Item $file.FullName -Force
          }
      } else {
          Write-Host "Current backup count ($($backups.Count)) is within limit ($limit)."
      }
      
    displayName: 'Execute IIS Website Backup'
    condition: ${{ parameters.runCondition }}