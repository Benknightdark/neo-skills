# ==============================================================================
# Template Name: Manage IIS Website (iis-manage-website.yml)
# Description: 
#   This template is responsible for creating or updating IIS Website, Application Pool (AppPool), and setting Site Bindings.
#   Implemented using PowerShell (WebAdministration module) to ensure settings meet expectations.
# ==============================================================================

parameters:
  # Website Name (Display name in IIS)
  - name: websiteName
    type: string
  
  # Website Physical Path (Absolute path on Server)
  - name: websitePhysicalPath
    type: string
  
  # Application Pool Name
  - name: appPoolName
    type: string
  
  # AppPool .NET CLR Version (For .NET Core/5+, 'No Managed Code' is recommended)
  - name: appPoolDotNetVersion
    type: string
    default: 'No Managed Code'
    values:
      - 'No Managed Code'
      - 'v4.0'
      - 'v2.0'

  # Site Binding Settings (JSON List)
  # Format example: '[{"type":"http","port":80,"ip":"*","hostName":"sample.local"}]'
  - name: bindings
    type: string
    default: '[]'
  
  # Execution Condition
  - name: runCondition
    type: string
    default: 'succeeded()'

steps:
  # ----------------------------------------------------------------------------
  # Execute PowerShell script to manage IIS Website
  # Includes: Create/Config AppPool, Create/Config Website, Apply Bindings
  # ----------------------------------------------------------------------------
  - powershell: |
      $websiteName = "${{ parameters.websiteName }}"
      $physicalPath = "${{ parameters.websitePhysicalPath }}"
      $appPoolName = "${{ parameters.appPoolName }}"
      $appPoolDotNetVersion = "${{ parameters.appPoolDotNetVersion }}"
      $bindingsJson = '${{ parameters.bindings }}'
      
      Write-Host "Managing IIS Website: $websiteName"
      
      # Ensure WebAdministration module is loaded
      Import-Module WebAdministration

      # --- 1. Configure Application Pool (AppPool) ---
      if (!(Test-Path "IIS:\AppPools\$appPoolName")) {
          Write-Host "Creating Application Pool: $appPoolName"
          New-WebAppPool -Name $appPoolName
      }
      
      # Set .NET CLR Version
      # If .NET Core/5+, usually set to 'No Managed Code' (Empty string)
      $runtime = if ($appPoolDotNetVersion -eq 'No Managed Code') { "" } else { $appPoolDotNetVersion }
      Set-ItemProperty "IIS:\AppPools\$appPoolName" -Name "managedRuntimeVersion" -Value $runtime
      Write-Host "Application Pool '$appPoolName' managed runtime version set to: '$runtime'"

      # --- 2. Configure Website ---
      if (!(Test-Path "IIS:\Sites\$websiteName")) {
          Write-Host "Creating new website: $websiteName"
          # Assign a temporary Port 80 when creating, will be overwritten by Apply Bindings logic later
          New-Website -Name $websiteName -PhysicalPath $physicalPath -ApplicationPool $appPoolName -Port 80 -Force
      } else {
          Write-Host "Updating website settings (Physical Path and Application Pool)"
          Set-ItemProperty "IIS:\Sites\$websiteName" -Name "physicalPath" -Value $physicalPath
          Set-ItemProperty "IIS:\Sites\$websiteName" -Name "applicationPool" -Value $appPoolName
      }

      # --- 3. Apply Bindings ---
      # Sync Mode: Remove all existing bindings, keep only items in JSON settings
      if (-not [string]::IsNullOrWhiteSpace($bindingsJson)) {
          try {
              $bindings = $bindingsJson | ConvertFrom-Json
              
              if ($bindings.Count -gt 0) {
                  Write-Host "Applying binding settings..."
                  
                  # Remove all existing Bindings
                  Get-WebBinding -Name $websiteName | Remove-WebBinding
                  
                  # Add defined Bindings one by one
                  foreach ($b in $bindings) {
                      $protocol = if ($b.type) { $b.type } else { "http" }
                      $port = if ($b.port) { $b.port } else { 80 }
                      $ip = if ($b.ip) { $b.ip } else { "*" }
                      $hostName = if ($b.hostName) { $b.hostName } else { "" }
                      
                      Write-Host "Adding Binding: ${protocol}://${ip}:${port}/${hostName}"
                      New-WebBinding -Name $websiteName -Protocol $protocol -Port $port -IPAddress $ip -HostHeader $hostName
                  }
              } else {
                  Write-Host "Binding settings list is empty, skipping update."
              }
          } catch {
              Write-Warning "Failed to parse Bindings JSON: $_"
              Write-Warning "Original JSON Content: $bindingsJson"
          }
      }
    displayName: 'Manage IIS Website (Create/Update) - PowerShell'
    condition: ${{ parameters.runCondition }}
