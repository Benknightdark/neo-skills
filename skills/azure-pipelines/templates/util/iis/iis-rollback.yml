# ==============================================================================
# Template Name: IIS Rollback (iis-rollback.yml)
# Description: 
#   Restore action executed when deployment fails.
#   1. Check if there is a backup file generated by this deployment (Variable _GeneratedBackupPath).
#   2. If backup exists, restore files to website physical path.
#   3. Ensure IIS services (WAS, W3SVC) are running.
#   4. Restart IIS Website.
# ==============================================================================

parameters:
  - name: websiteName
    type: string
  - name: websitePhysicalPath
    type: string
  - name: runCondition
    type: string
    default: 'failed()'

steps:
  - powershell: |
      $websiteName = "${{ parameters.websiteName }}"
      $dest = "${{ parameters.websitePhysicalPath }}"
      $backupZip = $env:_GeneratedBackupPath
      
      Write-Host "Starting Rollback Process..."
      Write-Host "Website Name: $websiteName"
      
      # --- 1. Restore Files ---
      if (-not [string]::IsNullOrWhiteSpace($backupZip) -and (Test-Path $backupZip)) {
          Write-Host "Detected backup file: $backupZip"
          Write-Host "Restoring to: $dest"
          
          # Ensure destination directory exists
          if (-not (Test-Path $dest)) {
              New-Item -ItemType Directory -Force -Path $dest | Out-Null
          }
          
          # Extract and overwrite
          try {
              Expand-Archive -Path $backupZip -DestinationPath $dest -Force -ErrorAction Stop
              Write-Host "Files restored successfully."
          } catch {
              Write-Error "Restore failed: $_"
              # Continue attempting to start website even if restore fails
          }
      } else {
          Write-Host "No backup file detected from this run (possibly failed before backup step), skipping file restore."
      }

      # --- 2. Start Website ---
      
      function Ensure-Service-Running {
          param($Name)
          try {
              $svc = Get-Service -Name $Name -ErrorAction Stop
              if ($svc.Status -ne 'Running') {
                  Write-Warning "Service '$Name' is not running. Starting..."
                  Start-Service -Name $Name
                  
                  # Wait for start
                  $timeout = 15
                  $timer = [System.Diagnostics.Stopwatch]::StartNew()
                  while ($svc.Status -ne 'Running' -and $timer.Elapsed.TotalSeconds -lt $timeout) {
                      Start-Sleep -Seconds 1
                      $svc.Refresh()
                  }
              }
          } catch {
              Write-Warning "Check service '$Name' exception: $_"
          }
      }

      function Start-Site-WithAppCmd {
          param($Name)
          $appCmd = "$env:systemroot\system32\inetsrv\appcmd.exe"
          if (Test-Path $appCmd) {
              Start-Process -FilePath $appCmd -ArgumentList "start site /site.name:`"$Name`"" -Wait -NoNewWindow
          }
      }

      # Ensure Core Services
      Ensure-Service-Running -Name "WAS"
      Ensure-Service-Running -Name "W3SVC"

      # Start Website
      try {
          Import-Module WebAdministration
          Start-Website -Name $websiteName -ErrorAction Stop
          Write-Host "Website '$websiteName' restarted."
      } catch {
          Write-Warning "PowerShell start failed, trying appcmd..."
          Start-Site-WithAppCmd -Name $websiteName
      }
      
    displayName: 'Execute Rollback (Restore and Restart)'
    # Execute only if previous steps failed AND deployment process was confirmed started (Variable _IISDeploymentStarted = true)
    condition: ${{ parameters.runCondition }}